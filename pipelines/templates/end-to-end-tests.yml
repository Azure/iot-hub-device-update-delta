# File: end-to-end-linux.yml
parameters:
- name: solution
  type: string
  default: '$(Build.SourcesDirectory)/build/diff-generation.sln'
- name: platform
  type: string
  default: 'x64'
- name: configuration
  type: string
  default: 'Release'
- name: diffgentool_artifact_name
  type: string
- name: diffgentool_files_dir
  type: string
  default: $(Build.ArtifactStagingDirectory)/diffgen
- name: end_to_end_tests_project
  type: string
  default: $(Build.SourcesDirectory)/src/managed/DiffGen/tests/EndToEndTests/EndToEndTests.csproj
- name: end_to_end_tests_bin_dir
  type: string
  default: $(Build.SourcesDirectory)/src/managed/DiffGen/tests/EndToEndTests/bin
- name: install_dependencies_script
  type: string
  default: ''
- name: post_download_artifact_script
  type: string
  default: ''

steps:
- task: CmdLine@2
  condition: ne('${{ parameters.install_dependencies_script }}', '')
  inputs:
    script: |
      chmod +x ${{ parameters.install_dependencies_script}}
      ${{ parameters.install_dependencies_script}}
  displayName: Install dependencies.

- task: UseDotNet@2
  displayName: 'Use .NET Standard sdk'
  inputs:
    packageType: sdk
    version: 6.x
    installationPath: $(Agent.ToolsDirectory)/dotnet

- task: NuGetToolInstaller@1

- task: NuGetCommand@2
  inputs:
    restoreSolution: '${{ parameters.solution }}'

- task: DotNetCoreCLI@2
  inputs:
    command: build
    projects: '${{ parameters.end_to_end_tests_project }}'
    arguments: '--configuration ${{ parameters.configuration }}'

- task: DownloadPipelineArtifact@2
  displayName: 'Download Microsoft x64-windows binaries'
  inputs:
    artifactName: ${{ parameters.diffgentool_artifact_name }}
    targetPath: ${{ parameters.diffgentool_files_dir }}

- script: |
    cp ${{ parameters.diffgentool_files_dir }}/* ${{ parameters.end_to_end_tests_bin_dir }}/${{ parameters.configuration }}/net6.0
    ls ${{ parameters.end_to_end_tests_bin_dir }}/${{ parameters.configuration }}/net6.0
  displayName: Copy diffgentool files to end to end tests dir

- task: CmdLine@2
  condition: ne('${{ parameters.post_download_artifact_script }}', '')
  inputs:
    script: |
      pushd ${{ parameters.end_to_end_tests_bin_dir }}/${{ parameters.configuration }}/net6.0
      chmod +x ${{ parameters.post_download_artifact_script }}
      ${{ parameters.post_download_artifact_script }}
      popd
  displayName: Run post-download script on diffgentool files.

- task: DotNetCoreCLI@2
  inputs:
    command: test
    projects: '${{ parameters.end_to_end_tests_project }}'
    arguments: '--configuration ${{ parameters.configuration }}'
