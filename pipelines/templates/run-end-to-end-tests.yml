# File: run-end-to-end_tests.yml

parameters:
# Required Parameters
- name: nuget_files_dir
  type: string
# Optional Parameters
- name: platform
  type: string
  default: x64
- name: configuration
  type: string
  default: Release
- name: package_dir
  type: string
  default: ''

steps:

- template: /pipelines/templates/build-managed.yml@self

- task: PowerShell@2
  inputs:
    targetType: inline
    script: |
      tree $(end_to_end_tests_bin_dir) /f
      copy ${{ parameters.nuget_files_dir }}\lib\$(diffgen_framework)\* $(end_to_end_tests_bin_dir)\\${{ parameters.configuration }}\$(diffgen_framework)
      mkdir $(end_to_end_tests_bin_dir)//${{ parameters.configuration }}/$(diffgen_framework)/bin
      copy ${{ parameters.nuget_files_dir }}/bin/DiffGenTool/x64-windows/* $(end_to_end_tests_bin_dir)//${{ parameters.configuration }}/$(diffgen_framework)/bin
  displayName: 'Copy Nuget Files to EndToEndTests'
  condition: eq( variables['Agent.OS'], 'Windows_NT' )

- task: VSTest@2
  condition: eq( variables['Agent.OS'], 'Windows_NT' )
  inputs:
    platform: '${{ parameters.platform }}'
    configuration: '${{ parameters.configuration }}'
    testAssemblyVer2: |
      $(end_to_end_tests_bin_dir)\\${{ parameters.configuration }}\$(diffgen_framework)\EndToEndTests.dll

- bash: |
    echo "EndToEnd Tests Folder: $(end_to_end_tests_bin_dir)/${{ parameters.configuration }}/$(diffgen_framework)/bin"

    cp ${{ parameters.nuget_files_dir }}/lib/$(diffgen_framework)/* $(end_to_end_tests_bin_dir)//${{ parameters.configuration }}/$(diffgen_framework)/bin
    cp ${{ parameters.nuget_files_dir }}/bin/DiffGenTool/x64-Linux/* $(end_to_end_tests_bin_dir)//${{ parameters.configuration }}/$(diffgen_framework)/bin

    chmod +x $(end_to_end_tests_bin_dir)/${{ parameters.configuration }}/$(diffgen_framework)/bin/dumpextfs
    chmod +x $(end_to_end_tests_bin_dir)/${{ parameters.configuration }}/$(diffgen_framework)/bin/bsdiff
    chmod +x $(end_to_end_tests_bin_dir)/${{ parameters.configuration }}/$(diffgen_framework)/bin/bspatch
    chmod +x $(end_to_end_tests_bin_dir)/${{ parameters.configuration }}/$(diffgen_framework)/bin/zstd_compress_file
    ls $(end_to_end_tests_bin_dir)/${{ parameters.configuration }}/$(diffgen_framework)/bin
  displayName: 'Copy Nuget Files to EndToEndTests (Linux)'
  condition: eq( variables['Agent.OS'], 'Linux' )

- task: CmdLine@2
  inputs:
    script: |
      sudo apt install ${{ parameters.package_dir }}/*.deb
  displayName: Install package (Linux)
  condition: eq( variables['Agent.OS'], 'Linux' )

- task: CmdLine@2
  condition: eq( variables['Agent.OS'], 'Linux' )
  inputs:
    script: |
      pushd $(end_to_end_tests_bin_dir)/${{ parameters.configuration }}/$(diffgen_framework)
      chmod +x $(setup_diffgen_tool_x64_linux_script)
      $(setup_diffgen_tool_x64_linux_script)
      popd
  displayName: Setup diffgentool for execute

- task: NuGetAuthenticate@0
  condition: eq( variables['Agent.OS'], 'Linux' )
  inputs:
    forceReinstallCredentialProvider: true

- task: DotNetCoreCLI@2
  condition: eq( variables['Agent.OS'], 'Linux' )
  inputs:
    command: 'test'
    projects: '$(end_to_end_tests_project)'
    arguments: '--configuration ${{ parameters.configuration }}'
