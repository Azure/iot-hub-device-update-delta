# File: bsdiff-template.yml
# This template uses multiple other templates to build,
# test and publish the content for the diffapi project.
parameters:
- name: vcpkg_dir
  type: string
  default: $(Agent.BuildDirectory)/vcpkg
- name: vcpkg_triplet
  type: string
- name: enable_sign
  type: boolean
  default: true
- name: bootstrap_script
  type: string
  default: bootstrap-vcpkg.bat
- name: binary_extension
  type: string
  default: .exe
- name: copy_bsdiff_and_bz2_dll
  type: boolean
  default: true
- name: bsdiff_signing_location
  type: string
  default: $(Build.ArtifactStagingDirectory)\signing

steps:
- task: CmdLine@2
  displayName: 'Setup VCPKG'
  inputs:
    script: |
      echo git clone https://github.com/microsoft/vcpkg ${{ parameters.vcpkg_dir }}
      git clone https://github.com/microsoft/vcpkg ${{ parameters.vcpkg_dir }}
      echo ${{ parameters.vcpkg_dir }}/${{ parameters.bootstrap_script }}
      ${{ parameters.vcpkg_dir }}/${{ parameters.bootstrap_script }}

- task: CmdLine@2
  displayName: 'Install bsdiff'
  inputs:
    script: |
      echo ${{ parameters.vcpkg_dir }}/vcpkg install bsdiff:${{ parameters.vcpkg_triplet }} --overlay-ports=$(Build.Repository.LocalPath)/vcpkg/ports/bsdiff
      ${{ parameters.vcpkg_dir }}/vcpkg install bsdiff:${{ parameters.vcpkg_triplet }} --overlay-ports=$(Build.Repository.LocalPath)/vcpkg/ports/bsdiff
      echo ${{ parameters.vcpkg_dir }}/vcpkg integrate install
      ${{ parameters.vcpkg_dir }}/vcpkg integrate install

- task: CmdLine@2
  displayName: 'Copy BSDiff and BSPatch binaries'
  inputs:
    script: |
      mkdir ${{ parameters.bsdiff_signing_location }}
      cp ${{ parameters.vcpkg_dir }}/packages/bsdiff_${{ parameters.vcpkg_triplet }}/bin/bsdiff_diff${{ parameters.binary_extension }} ${{ parameters.bsdiff_signing_location }}/bsdiff${{ parameters.binary_extension }}
      cp ${{ parameters.vcpkg_dir }}/packages/bsdiff_${{ parameters.vcpkg_triplet }}/bin/bsdiff_patch${{ parameters.binary_extension }} ${{ parameters.bsdiff_signing_location }}/bspatch${{ parameters.binary_extension }}

- ${{ if eq(parameters.copy_bsdiff_and_bz2_dll, true) }}:
  - task: CmdLine@2
    displayName: 'Copy BSDiff and BSPatch binaries'
    inputs:
      script: |
        mkdir ${{ parameters.bsdiff_signing_location }}
        cp ${{ parameters.vcpkg_dir }}/packages/bsdiff_${{ parameters.vcpkg_triplet }}/bin/bsdiff.dll ${{ parameters.bsdiff_signing_location }}/bsdiff.dll
        cp ${{ parameters.vcpkg_dir }}/packages/bzip2_${{ parameters.vcpkg_triplet }}/bin/bz2.dll ${{ parameters.bsdiff_signing_location }}/bz2.dll

- ${{ if eq(parameters.copy_bsdiff_and_bz2_dll, true) }}:
  - ${{ if eq(parameters.enable_sign, true) }}:
    - task: EsrpCodeSigning@1
      inputs:
        ConnectedServiceName: 'ADU Diffs ESRP CodeSigning'
        FolderPath: '${{ parameters.bsdiff_signing_location }}'
        Pattern: |
          bsdiff.dll
          bz2.dll
        signConfigType: 'inlineSignParams'
        inlineOperation: |
          [
            {
              "keyCode": "CP-231522",
              "operationSetCode": "SigntoolSign",
              "parameters": [
                {
                  "parameterName": "OpusName",
                  "parameterValue": "Microsoft"
                },
                {
                  "parameterName": "OpusInfo",
                  "parameterValue": "http://www.microsoft.com"
                },
                {
                  "parameterName": "PageHash",
                  "parameterValue": "/NPH"
                },
                {
                  "parameterName": "FileDigest",
                  "parameterValue": "/fd sha256"
                },
                {
                  "parameterName": "TimeStamp",
                  "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                }
              ],
              "toolName": "signtool.exe",
              "toolVersion": "6.2.9304.0"
            }
          ]
        SessionTimeout: '60'
        MaxConcurrency: '50'
        MaxRetryAttempts: '5'

- ${{ if eq(parameters.enable_sign, true) }}:
  - task: EsrpCodeSigning@1
    inputs:
      ConnectedServiceName: 'ADU Diffs ESRP CodeSigning'
      FolderPath: '${{ parameters.bsdiff_signing_location }}'
      Pattern: |
        bsdiff${{ parameters.binary_extension }}
        bspatch${{ parameters.binary_extension }}
      signConfigType: 'inlineSignParams'
      inlineOperation: |
        [
          {
            "keyCode": "CP-231522",
            "operationSetCode": "SigntoolSign",
            "parameters": [
              {
                "parameterName": "OpusName",
                "parameterValue": "Microsoft"
              },
              {
                "parameterName": "OpusInfo",
                "parameterValue": "http://www.microsoft.com"
              },
              {
                "parameterName": "PageHash",
                "parameterValue": "/NPH"
              },
              {
                "parameterName": "FileDigest",
                "parameterValue": "/fd sha256"
              },
              {
                "parameterName": "TimeStamp",
                "parameterValue": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
              }
            ],
            "toolName": "signtool.exe",
            "toolVersion": "6.2.9304.0"
          }
        ]
      SessionTimeout: '60'
      MaxConcurrency: '50'
      MaxRetryAttempts: '5'

- task: CmdLine@2
  displayName: 'Copy Built Binaries'
  inputs:
    script: |
      cp ${{ parameters.bsdiff_signing_location }}/bsdiff${{ parameters.binary_extension }} $(Build.ArtifactStagingDirectory)/bsdiff${{ parameters.binary_extension }}
      cp ${{ parameters.bsdiff_signing_location }}/bspatch${{ parameters.binary_extension }} $(Build.ArtifactStagingDirectory)/bspatch${{ parameters.binary_extension }}

- task: CmdLine@2
  displayName: 'Copy Licenses'
  inputs:
    script: |
      cp ${{ parameters.vcpkg_dir }}/packages/bsdiff_${{ parameters.vcpkg_triplet }}/share/bsdiff/copyright $(Build.ArtifactStagingDirectory)/LICENSE.bsdiff
      cp ${{ parameters.vcpkg_dir }}/packages/bzip2_${{ parameters.vcpkg_triplet }}/share/bzip2/copyright $(Build.ArtifactStagingDirectory)/LICENSE.bzip2

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'
    artifactType: 'pipeline'
    artifactName: 'drop'
